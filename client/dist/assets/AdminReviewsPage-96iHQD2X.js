import{j as e}from"./editor-BiSlXHWs.js";import{a as r}from"./vendor-0z5P9xg-.js";import{A as t}from"./AdminLayout-Cnhsu9ug.js";import{z as o}from"./index-BiO51Ilc.js";import"./redux-DhaBhdiE.js";const s="https://api.wolfsupplies.co.uk",a=()=>{const[t,a]=r.useState("all"),[l,i]=r.useState([]),[c,n]=r.useState(null),[d,p]=r.useState([]),[m,u]=r.useState(!1),[v,h]=r.useState(0),[x,g]=r.useState(0),[y,f]=r.useState(0),[b,w]=r.useState(!0),[j,N]=r.useState(!1),[C,A]=r.useState("all"),[k,$]=r.useState(""),S=localStorage.getItem("token");r.useEffect(()=>{(async()=>{try{const e=await fetch(`${s}/api/settings`);if(!e.ok)throw new Error("Failed to fetch settings");const r=await e.json();w(!1!==r.requireReviewApproval)}catch(e){}})()},[]),r.useEffect(()=>{(async()=>{try{const e=await fetch(`${s}/api/products`);if(!e.ok)throw new Error("Failed to fetch products");const r=await e.json();i(r.products||[])}catch(e){}})()},[]),r.useEffect(()=>{"all"===t&&l.length>0&&(async()=>{u(!0);try{const e=[];for(const a of l)if(a.reviews&&a.reviews.length>0){const r=await fetch(`${s}/api/products/${a._id}`),t=await r.json();for(let o=0;o<t.reviews.length;o++){const r=t.reviews[o];e.push({...r,productId:a._id,productName:a.name,reviewIndex:o})}}const r=await Promise.all(e.map(async e=>{try{if(e.user&&"object"!=typeof e.user){const r=await fetch(`${s}/api/users/${e.user}`);if(r.ok){const t=await r.json();e.user=t.user||t}}else if(e.user&&"object"==typeof e.user&&!e.user.email&&e.user._id){const r=await fetch(`${s}/api/users/${e.user._id}`);if(r.ok){const t=await r.json();e.user=t.user||t}}}catch(r){}return e})),t=r.reduce((e,r)=>r.isApproved?e+1:e,0),o=r.reduce((e,r)=>r.isApproved?e:e+1,0);p(r),h(t),g(o),f(r.length)}catch(e){o.error("Failed to fetch reviews")}finally{u(!1)}})()},[t,l]),r.useEffect(()=>{"by-product"===t&&c&&(async()=>{if(c){u(!0);try{const e=await fetch(`${s}/api/products/${c}`);if(!e.ok)throw new Error("Failed to fetch product");const r=await e.json();if(r.reviews&&r.reviews.length>0){const e=r.reviews.map((e,t)=>({...e,productId:r._id,productName:r.name,reviewIndex:t})),t=await Promise.all(e.map(async e=>{try{if(e.user&&"object"!=typeof e.user){const r=await fetch(`${s}/api/users/${e.user}`);if(r.ok){const t=await r.json();e.user=t.user||t}}else if(e.user&&"object"==typeof e.user&&!e.user.email&&e.user._id){const r=await fetch(`${s}/api/users/${e.user._id}`);if(r.ok){const t=await r.json();e.user=t.user||t}}}catch(r){}return e}));p(t)}else p([])}catch(e){o.error("Failed to fetch product reviews")}finally{u(!1)}}else p([])})()},[t,c]);const R=r=>{const t=[];for(let o=1;o<=5;o++)r>=o?t.push(e.jsx("i",{className:"fas fa-star text-yellow-400"},o)):r>=o-.5?t.push(e.jsx("i",{className:"fas fa-star-half text-yellow-400"},o)):t.push(e.jsx("i",{className:"far fa-star text-yellow-400"},o));return t};return e.jsxs("div",{className:"p-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",style:{color:"var(--color-text-primary)"},children:"Review Management"}),e.jsx("div",{className:"rounded-lg shadow-lg p-6 mb-8",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-accent-primary)",borderLeftWidth:"4px"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold mb-2",style:{color:"var(--color-text-primary)"},children:"Review Approval Setting"}),e.jsx("p",{className:"text-sm",style:{color:"var(--color-text-light)"},children:b?"Reviews require admin approval before appearing on product pages":"Reviews appear immediately without requiring approval"})]}),e.jsx("button",{onClick:async()=>{N(!0);try{if(!(await fetch(`${s}/api/settings`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify({requireReviewApproval:!b})})).ok)throw new Error("Failed to update settings");w(!b),o.success(b?"Reviews will now show immediately without approval":"Reviews will now require approval before showing")}catch(e){o.error("Failed to update settings")}finally{N(!1)}},disabled:j,className:"px-6 py-3 rounded-lg font-semibold transition "+(j?"opacity-50 cursor-not-allowed":""),style:{backgroundColor:b?"var(--color-accent-primary)":"var(--color-text-secondary)",color:"white"},onMouseEnter:e=>!e.target.disabled&&(e.target.style.backgroundColor="var(--color-accent-light)"),onMouseLeave:e=>!e.target.disabled&&(e.target.style.backgroundColor=b?"var(--color-accent-primary)":"var(--color-text-secondary)"),children:j?"Saving...":b?"Approval Required":"No Approval Required"})]})}),"all"===t&&e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"rounded-lg shadow p-6",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-accent-primary)",borderLeftWidth:"4px"},children:[e.jsx("p",{className:"text-sm font-semibold mb-2",style:{color:"var(--color-text-light)"},children:"Total Reviews"}),e.jsx("p",{className:"text-3xl font-bold",style:{color:"var(--color-accent-primary)"},children:y})]}),e.jsxs("div",{className:"rounded-lg shadow p-6",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-accent-light)",borderLeftWidth:"4px"},children:[e.jsx("p",{className:"text-sm font-semibold mb-2",style:{color:"var(--color-text-light)"},children:"Verified"}),e.jsx("p",{className:"text-3xl font-bold",style:{color:"var(--color-accent-light)"},children:v})]}),e.jsxs("div",{className:"rounded-lg shadow p-6",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-text-secondary)",borderLeftWidth:"4px"},children:[e.jsx("p",{className:"text-sm font-semibold mb-2",style:{color:"var(--color-text-light)"},children:"Pending"}),e.jsx("p",{className:"text-3xl font-bold",style:{color:"var(--color-text-secondary)"},children:x})]})]})]}),e.jsxs("div",{className:"mb-8 flex gap-4 justify-between items-center",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>{a("all"),n(null),A("all")},className:"px-6 py-3 rounded-lg font-semibold transition",style:{backgroundColor:"all"===t?"var(--color-accent-primary)":"var(--color-bg-section)",color:"all"===t?"white":"var(--color-text-primary)"},onMouseEnter:e=>e.target.style.backgroundColor="all"===t?"var(--color-accent-light)":"var(--color-border-light)",onMouseLeave:e=>e.target.style.backgroundColor="all"===t?"var(--color-accent-primary)":"var(--color-bg-section)",children:"All Reviews"}),e.jsx("button",{onClick:()=>a("by-product"),className:"px-6 py-3 rounded-lg font-semibold transition",style:{backgroundColor:"by-product"===t?"var(--color-accent-primary)":"var(--color-bg-section)",color:"by-product"===t?"white":"var(--color-text-primary)"},onMouseEnter:e=>e.target.style.backgroundColor="by-product"===t?"var(--color-accent-light)":"var(--color-border-light)",onMouseLeave:e=>e.target.style.backgroundColor="by-product"===t?"var(--color-accent-primary)":"var(--color-bg-section)",children:"Reviews by Product"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 cursor-pointer",children:["ðŸ“¥ Import Reviews",e.jsx("input",{type:"file",accept:".csv",onChange:async e=>{const r=e.target.files?.[0];if(r)if(r.name.endsWith(".csv"))try{const l=(await r.text()).trim().split("\n");if(l.length<2)return void o.error("CSV file must have headers and at least one review row");const i=e=>{const r=[];let t="",o=!1;for(let s=0;s<e.length;s++){const a=e[s],l=e[s+1];'"'===a?o&&'"'===l?(t+='"',s++):o=!o:","!==a||o?t+=a:(r.push(t.trim()),t="")}return r.push(t.trim()),r},c=e=>e.toLowerCase().replace(/\s+/g," ").trim(),n=l[0],d=i(n).map(c),p=(e,r)=>{const t=c(r);return Object.entries(e).find(([e])=>c(e)===t)?.[1]||""};let m=0,u=0;for(let e=1;e<l.length;e++){const r=l[e].trim();if(!r)continue;const o=i(r),a={};d.forEach((e,r)=>{a[e]=o[r]||""});const c=p(a,"product id"),n=p(a,"comment"),v=parseInt(p(a,"rating"))||0,h="approved"===p(a,"status")?.toLowerCase(),x=p(a,"user name"),g=p(a,"user email");if(c&&n&&v)try{if((await fetch(`${s}/api/products/${c}/reviews`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify({name:x||"Imported Review",email:g||"",rating:v,comment:n})})).ok){if(h!==b){const e=await fetch(`${s}/api/products/${c}`),r=await e.json();if(r.reviews&&r.reviews.length>0){const e=r.reviews.length-1;await fetch(`${s}/api/products/${c}/reviews/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify({isApproved:h})})}}m++}else u++}catch(t){u++}else u++}o.success(`Imported ${m} review(s)${u>0?` (${u} failed)`:""}`),a(""),setTimeout(()=>a("all"),50),e.target.value=""}catch(t){o.error(t.message||"Failed to import reviews")}else o.error("Please upload a valid CSV file")},className:"hidden"})]}),e.jsx("button",{onClick:()=>{try{const e=["Review ID","Product Name","Product ID","User Name","User Email","Rating","Comment","Status","Created At"],r=d.map(e=>[e._id||"",`"${(e.productName||"").replace(/"/g,'""')}"`,e.productId||"",`"${(e.name||"").replace(/"/g,'""')}"`,e.user?.email||e.email||"",e.rating||"0",`"${(e.comment||"").replace(/"/g,'""').replace(/\n/g," ")}"`,e.isApproved?"Approved":"Pending",e.createdAt?new Date(e.createdAt).toLocaleString():""]),t=[e.join(","),...r.map(e=>e.join(","))].join("\n"),s=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download=`reviews_export_${(new Date).getTime()}.csv`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),o.success(`Exported ${d.length} review(s) successfully`)}catch(e){o.error("Failed to export reviews")}},disabled:0===d.length,className:"flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition duration-300 "+(0===d.length?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"),children:"ðŸ“¤ Export Reviews"})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx("input",{type:"text",value:k,onChange:e=>$(e.target.value),placeholder:"Search reviews by name, email, product or text...",className:"w-full px-4 py-3 border-2 rounded-lg focus:outline-none transition",style:{borderColor:"var(--color-border-light)",color:"var(--color-text-primary)"},onFocus:e=>e.target.style.borderColor="var(--color-accent-primary)",onBlur:e=>e.target.style.borderColor="var(--color-border-light)"})}),"all"===t&&e.jsxs("div",{className:"mb-8 flex gap-3 border-b",style:{borderColor:"var(--color-border-light)"},children:[e.jsxs("button",{onClick:()=>A("all"),className:"px-4 py-3 font-semibold border-b-2 transition",style:{borderColor:"all"===C?"var(--color-accent-primary)":"transparent",color:"all"===C?"var(--color-accent-primary)":"var(--color-text-light)"},children:["All (",y,")"]}),e.jsxs("button",{onClick:()=>A("approved"),className:"px-4 py-3 font-semibold border-b-2 transition",style:{borderColor:"approved"===C?"var(--color-accent-light)":"transparent",color:"approved"===C?"var(--color-accent-light)":"var(--color-text-light)"},children:["Verified (",v,")"]}),e.jsxs("button",{onClick:()=>A("pending"),className:"px-4 py-3 font-semibold border-b-2 transition",style:{borderColor:"pending"===C?"var(--color-text-secondary)":"transparent",color:"pending"===C?"var(--color-text-secondary)":"var(--color-text-light)"},children:["Pending (",x,")"]})]}),"by-product"===t&&e.jsxs("div",{className:"mb-8",children:[e.jsx("label",{className:"block text-sm font-semibold mb-3",style:{color:"var(--color-text-primary)"},children:"Select Product"}),e.jsxs("select",{value:c||"",onChange:e=>n(e.target.value||null),className:"w-full px-4 py-2 border-2 rounded-lg focus:outline-none transition",style:{borderColor:"var(--color-border-light)",color:"var(--color-text-primary)"},onFocus:e=>e.target.style.borderColor="var(--color-accent-primary)",onBlur:e=>e.target.style.borderColor="var(--color-border-light)",children:[e.jsx("option",{value:"",children:"-- Choose a product --"}),l.map(r=>e.jsxs("option",{value:r._id,children:[r.name," (",r.reviews?.length||0," reviews)"]},r._id))]})]}),m&&e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("i",{className:"fas fa-spinner text-4xl animate-spin",style:{color:"var(--color-accent-primary)"}})}),!m&&e.jsx("div",{className:"space-y-6",children:(()=>{let r=d;if("all"===t&&("approved"===C?r=d.filter(e=>e.isApproved):"pending"===C&&(r=d.filter(e=>!e.isApproved))),k&&""!==k.trim()){const e=k.trim().toLowerCase();r=r.filter(r=>{const t=(r.email||r.user&&("object"==typeof r.user?r.user.email:r.user)||"").toString().toLowerCase(),o=(r.name||r.user&&("object"==typeof r.user?r.user.name:"")||"").toString().toLowerCase(),s=(r.productName||"").toString().toLowerCase(),a=(r.comment||"").toString().toLowerCase();return t.includes(e)||o.includes(e)||s.includes(e)||a.includes(e)})}return r.length>0?r.map((r,l)=>e.jsxs("div",{className:"rounded-lg shadow-lg p-6",style:{backgroundColor:"var(--color-bg-primary)",borderColor:r.isApproved?"var(--color-accent-light)":"var(--color-text-secondary)",borderLeftWidth:"4px"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h3",{className:"text-lg font-bold",style:{color:"var(--color-text-primary)"},children:r.name}),r.isApproved&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold",style:{backgroundColor:"var(--color-bg-section)",color:"var(--color-accent-primary)"},children:"âœ“ Verified"}),!r.isApproved&&e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold",style:{backgroundColor:"var(--color-bg-section)",color:"var(--color-text-secondary)"},children:"â³ Pending"})]}),"all"===t&&e.jsxs("p",{className:"text-sm font-semibold",style:{color:"var(--color-text-light)"},children:["Product: ",e.jsx("span",{style:{color:"var(--color-accent-primary)"},children:r.productName})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"flex gap-1 mb-2 justify-end",children:R(r.rating).map((r,t)=>e.jsx("span",{className:"text-lg",children:r},t))}),e.jsx("p",{className:"text-sm",style:{color:"var(--color-text-light)"},children:new Date(r.createdAt||r.updatedAt||Date.now()).toLocaleDateString()})]})]}),e.jsx("p",{className:"mb-6 leading-relaxed",style:{color:"var(--color-text-primary)"},children:r.comment}),e.jsxs("div",{className:"flex items-center justify-between pt-4",style:{borderColor:"var(--color-border-light)",borderTopWidth:"1px"},children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",style:{color:"var(--color-text-secondary)"},children:"Email: "}),e.jsx("span",{style:{color:"var(--color-text-primary)"},children:r.email||(r.user&&"object"==typeof r.user?r.user.email:r.user)||"Guest"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>(async(e,r)=>{try{const l=d.findIndex(t=>t.productId===e&&t.reviewIndex===r),i=-1!==l?!!d[l].isApproved:null,c=null===i||!i;if(!(await fetch(`${s}/api/products/${e}/reviews/${r}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`},body:JSON.stringify({isApproved:c})})).ok)throw new Error("Failed to update review");if(-1!==l){const e=[...d];e[l].isApproved=!!c,p(e),o.success(e[l].isApproved?"Review approved":"Review disapproved"),"all"===t&&(h(e.reduce((e,r)=>r.isApproved?e+1:e,0)),g(e.reduce((e,r)=>r.isApproved?e:e+1,0)))}else"all"===t&&(a(""),setTimeout(()=>a("all"),50))}catch(l){o.error(l.message)}})(r.productId,r.reviewIndex),className:"flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition "+(r.isApproved?"bg-yellow-100 text-yellow-800 hover:bg-yellow-200":"bg-gray-100 text-gray-800 hover:bg-gray-200"),children:r.isApproved?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-times"})," Unverify"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-check"})," Verify"]})}),e.jsx("button",{onClick:()=>(async(e,r)=>{if(window.confirm("Are you sure you want to delete this review?"))try{if(!(await fetch(`${s}/api/products/${e}/reviews/${r}`,{method:"DELETE",headers:{Authorization:`Bearer ${S}`}})).ok)throw new Error("Failed to delete review");const a=d.filter(t=>!(t.productId===e&&t.reviewIndex===r));p(a),o.success("Review deleted"),"all"===t&&(h(a.reduce((e,r)=>r.isApproved?e+1:e,0)),g(a.reduce((e,r)=>r.isApproved?e:e+1,0)),f(a.length))}catch(a){o.error(a.message)}})(r.productId,r.reviewIndex),className:"px-4 py-2 rounded-lg font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition",children:"Delete"})]})]})]},l)):e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-12 text-center",children:[e.jsx("div",{className:"text-5xl mb-4",children:"ðŸ“‹"}),e.jsx("p",{className:"text-xl text-gray-600 font-semibold mb-2",children:"No reviews found"}),e.jsx("p",{className:"text-gray-900",children:"by-product"===t&&c?"This product has no reviews yet":"approved"===C?"No approved reviews yet":"pending"===C?"No pending reviews":"No reviews to manage"})]})})()})]})},l=()=>e.jsx(t,{activeTab:"reviews",children:e.jsx(a,{})});export{l as default};
